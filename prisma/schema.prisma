// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id           String   @id @default(cuid())
  clerkId      String   @unique
  email        String   @unique
  phone        String?  @unique
  firstName    String?
  lastName     String?
  profileImage String?
  role         Role     @default(RIDER)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  rides         Ride[]
  sharedRides   SharedRidePassenger[]
  dailyCabs     DailyCabSubscription[]
  payments      Payment[]
  ratingsGiven  Rating[]               @relation("RatingsGiven")
  savedPlaces   SavedPlace[]
  notifications Notification[]
  driverProfile DriverProfile?
}

model DriverProfile {
  id            String      @id @default(cuid())
  userId        String      @unique
  user          User        @relation(fields: [userId], references: [id])
  licenseNumber String
  licenseExpiry DateTime
  vehicleType   VehicleType
  vehicleMake   String
  vehicleModel  String
  vehicleYear   Int
  vehicleColor  String
  licensePlate  String      @unique
  isVerified    Boolean     @default(false)
  isOnline      Boolean     @default(false)
  currentLat    Float?
  currentLng    Float?
  rating        Float       @default(5.0)
  totalTrips    Int         @default(0)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  rides           Ride[]
  earnings        DriverEarning[]
  ratingsReceived Rating[]        @relation("RatingsReceived")
}

model Ride {
  id            String         @id @default(cuid())
  riderId       String
  rider         User           @relation(fields: [riderId], references: [id])
  driverId      String?
  driver        DriverProfile? @relation(fields: [driverId], references: [id])
  type          RideType
  status        RideStatus     @default(PENDING)
  pickupLat     Float
  pickupLng     Float
  pickupAddress String
  dropLat       Float
  dropLng       Float
  dropAddress   String
  distance      Float?
  duration      Int?
  fare          Float?
  scheduledAt   DateTime?
  startedAt     DateTime?
  completedAt   DateTime?
  cancelledAt   DateTime?
  cancelReason  String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  payment Payment?
  rating  Rating?
}

model SharedRide {
  id             String     @id @default(cuid())
  driverId       String?
  status         RideStatus @default(PENDING)
  routeStart     String
  routeEnd       String
  departureTime  DateTime
  availableSeats Int
  pricePerSeat   Float
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  passengers SharedRidePassenger[]
}

model SharedRidePassenger {
  id            String          @id @default(cuid())
  sharedRideId  String
  sharedRide    SharedRide      @relation(fields: [sharedRideId], references: [id])
  userId        String
  user          User            @relation(fields: [userId], references: [id])
  pickupAddress String
  dropAddress   String
  seats         Int             @default(1)
  status        PassengerStatus @default(PENDING)
  createdAt     DateTime        @default(now())
}

model DailyCabSubscription {
  id            String             @id @default(cuid())
  userId        String
  user          User               @relation(fields: [userId], references: [id])
  pickupLat     Float
  pickupLng     Float
  pickupAddress String
  dropLat       Float
  dropLng       Float
  dropAddress   String
  pickupTime    String // "08:30"
  daysOfWeek    Int[] // [1,2,3,4,5] Mon-Fri
  startDate     DateTime
  endDate       DateTime
  fare          Float
  status        SubscriptionStatus @default(ACTIVE)
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
}

model Payment {
  id            String        @id @default(cuid())
  userId        String
  user          User          @relation(fields: [userId], references: [id])
  rideId        String?       @unique
  ride          Ride?         @relation(fields: [rideId], references: [id])
  amount        Float
  method        PaymentMethod
  status        PaymentStatus @default(PENDING)
  transactionId String?
  createdAt     DateTime      @default(now())
}

model Rating {
  id        String        @id @default(cuid())
  rideId    String        @unique
  ride      Ride          @relation(fields: [rideId], references: [id])
  raterId   String
  rater     User          @relation("RatingsGiven", fields: [raterId], references: [id])
  driverId  String
  driver    DriverProfile @relation("RatingsReceived", fields: [driverId], references: [id])
  score     Int // 1-5
  comment   String?
  createdAt DateTime      @default(now())
}

model SavedPlace {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  name      String // "Home", "Work"
  lat       Float
  lng       Float
  address   String
  createdAt DateTime @default(now())
}

model DriverEarning {
  id          String        @id @default(cuid())
  driverId    String
  driver      DriverProfile @relation(fields: [driverId], references: [id])
  amount      Float
  type        EarningType
  description String?
  date        DateTime      @default(now())
}

model Notification {
  id        String           @id @default(cuid())
  userId    String
  user      User             @relation(fields: [userId], references: [id])
  title     String
  body      String
  type      NotificationType
  data      Json?
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())
}

// Enums
enum Role {
  RIDER
  DRIVER
  ADMIN
}

enum VehicleType {
  SEDAN
  SUV
  HATCHBACK
  AUTO
  BIKE
}

enum RideType {
  STANDARD
  SHARED
  DAILY_CAB
  LONG_TRIP
}

enum RideStatus {
  PENDING
  ACCEPTED
  ARRIVING
  STARTED
  COMPLETED
  CANCELLED
}

enum PassengerStatus {
  PENDING
  CONFIRMED
  PICKED_UP
  DROPPED
  CANCELLED
}

enum SubscriptionStatus {
  ACTIVE
  PAUSED
  CANCELLED
  EXPIRED
}

enum PaymentMethod {
  CASH
  UPI
  CARD
  WALLET
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum EarningType {
  RIDE
  BONUS
  TIP
  REFERRAL
}

enum NotificationType {
  RIDE_UPDATE
  PAYMENT
  PROMO
  SYSTEM
}
