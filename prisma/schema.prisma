// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// ENUMERATIONS for status fields across the application
enum UserRole {
  PASSENGER
  DRIVER
  ADMIN
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum VerificationStatus {
  PENDING
  APPROVED
  REJECTED
}

enum VehicleType {
  HATCHBACK
  SEDAN
  SUV
  LUXURY
}

enum RideStatus {
  SEARCHING_FOR_PASSENGERS /// Driver has set a route and is waiting for bookings
  IN_PROGRESS /// At least one passenger has been picked up
  COMPLETED /// All passengers have been dropped off
  CANCELLED /// Driver cancelled the entire trip
}

enum BookingStatus {
  REQUESTED /// Passenger has booked, waiting for driver confirmation/pickup
  ACCEPTED /// Driver has accepted the booking
  PICKED_UP
  DROPPED_OFF
  CANCELLED /// Passenger cancelled their specific booking
}

enum BookingCategory {
  LONGTRIP
  DIALYCAB
  HIRE
}

enum PaymentStatus {
  PENDING
  SUCCESSFUL
  FAILED
}

enum CancellationReason {
  CHANGE_OF_PLANS
  NO_LONGER_NEEDED
  BOOKED_BY_MISTAKE
  FOUND_ALTERNATIVE_TRANSPORT
  DRIVER_TOO_FAR
  DRIVER_ARRIVED_LATE
  VEHICLE_DETAILS_MISMATCH
  VEHICLE_NOT_CLEAN
  DRIVER_UNPROFESSIONAL
  RUNNING_LATE
  PERSONAL_EMERGENCY
  TRAVEL_TIME_CHANGED
  WORK_COMMITMENT
  WRONG_PICKUP_LOCATION
  COULD_NOT_LOCATE_DRIVER
  TRAFFIC_OR_ROAD_CLOSURE
  PICKUP_NOT_ACCESSIBLE
  FELT_UNSAFE
  UNCOMFORTABLE_WITH_DRIVER
  PICKUP_AREA_UNSAFE
  FARE_TOO_HIGH
  PAYMENT_ISSUE
  DISCOUNT_NOT_APPLIED
  SURGE_PRICING
  BAD_WEATHER
  EVENT_CANCELLED
  PUBLIC_DISTURBANCE
}

enum Languages {
  ENGLISH
  KANNADA
  HINDI
  MALAYALAM
  TAMIL
  KONKANI
  TELUGU
  TULU
}

/// MODELS

/// Represents any user in the system, can be a Passenger or a Driver
model User {
  id              String   @id @default(cuid())
  phone           String   @unique
  name            String
  email           String?  @unique
  password        String? // hashed password
  profileImageUrl String?
  role            UserRole @default(PASSENGER)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  age             Int
  gender          Gender

  // A user can be a driver (one-to-one)
  // A user can be a passenger in many rides
  bookings      Booking[]       @relation("PassengerBookings")
  PaymentMethod PaymentMethod[]
  Trip          Trip?           @relation(fields: [tripId], references: [id])
  tripId        String?
  Booking       Booking[]

  @@map("users")
}

model PassengerProfile {
  id       String    @id @default(cuid())
  language Languages @default(ENGLISH)
}

model PaymentMethod {
  id        String    @id @default(cuid())
  Passenger User      @relation(fields: [userId], references: [id])
  userId    String
  upi       UPI       @relation(fields: [uPIId], references: [id])
  uPIId     String
  card      Card      @relation(fields: [cardId], references: [id])
  cardId    String
  Reciept   Reciept[]
}

model UPI {
  id           String @id @default(cuid())
  vpa          String
  customerName String

  PaymentMethod PaymentMethod[]
}

model Card {
  id             String          @id @default(cuid())
  cardNumber     String
  cvv            String
  expiryDate     String
  billingAddress String
  PaymentMethod  PaymentMethod[]
}

/// Contains driver-specific information and is linked to a User account
model Driver {
  id                 String             @id @default(cuid())
  isAvailable        Boolean            @default(false)
  verificationStatus VerificationStatus @default(APPROVED)
  joinedAt           DateTime           @default(now())
  avgRating          Float              @default(0.0)
  gender             Gender
  email              String             @unique
  // Relation to the base User model (one-to-one)
  // A driver has one primary vehicle
  vehicle            Vehicle?
  // A driver has multiple documents for verification
  documents          DriverDocuments[]
  // A driver can conduct many rides
  trips              Trip[]

  @@map("drivers")
}

/// Vehicle information for a specific driver
model Vehicle {
  id                 String      @id @default(cuid())
  make               String
  model              String
  year               Int
  registrationNumber String      @unique
  type               VehicleType

  // Relation to the Driver model (one-to-one)
  driver   Driver @relation(fields: [driverId], references: [id])
  driverId String @unique

  @@map("vehicles")
}

model AadharCard {
  id             String            @id @default(cuid())
  adhaarNumber   BigInt            @unique
  name           String // Name as in AadharCard
  DriverDocument DriverDocuments[]
}

model DriverLicense {
  id             String            @id @default(cuid())
  DLNumber       String
  DOB            String
  DriverDocument DriverDocuments[]
}

model Stop {
  id       String @id @default(cuid())
  address  String
  landmark String
  pincode  Int

  tripStart      Trip[]    @relation("startingPoint")
  tripEnd        Trip[]    @relation("endingPoint")
  boardingPoints Booking[] @relation("BoardingPoint")
  dropoffPoints  Booking[] @relation("dropoffPoint")
}

/// Documents for driver verification
model DriverDocuments {
  id              String        @id @default(cuid())
  adhaarCard      AadharCard    @relation(fields: [aadharCardId], references: [id])
  driverLicense   DriverLicense @relation(fields: [driverLicenseId], references: [id])
  isVerified      Boolean       @default(true)
  driver          Driver        @relation(fields: [driverId], references: [id])
  driverId        String
  aadharCardId    String
  driverLicenseId String

  @@map("driver_documents")
}

/// Represents the entire trip taken by a driver's vehicle. It can contain multiple passengers.
model Trip {
  id            String     @id @default(cuid())
  status        RideStatus @default(SEARCHING_FOR_PASSENGERS)
  startTime     DateTime?
  endTime       DateTime?
  totalDistance Float? // in kilometers

  startingPoint Stop   @relation("startingPoint", fields: [startStopId], references: [id])
  startStopId   String
  endingPoint   Stop   @relation("endingPoint", fields: [endStopId], references: [id])
  endStopId     String

  driver   Driver @relation(fields: [driverId], references: [id])
  driverId String

  passengers User[]
  avgRating  Int?
  createdAt  DateTime @default(now())

  @@map("rides")
}

model Booking {
  id          String        @id @default(cuid())
  amount      Decimal       @db.Decimal(10, 2)
  status      BookingStatus @default(REQUESTED)
  BoardingOTP String? // Boarding OTP for this passenger

  boardingPoint  Stop   @relation("BoardingPoint", fields: [boardingStopId], references: [id])
  boardingStopId String
  dropoffPoint   Stop   @relation("dropoffPoint", fields: [dropoffStopId], references: [id])
  dropoffStopId  String

  passenger           User                  @relation("PassengerBookings", fields: [passengerId], references: [id])
  passengerId         String
  seat                String
  payment             Payment?
  User                User?                 @relation(fields: [userId], references: [id])
  userId              String?
  Ticket              Ticket[]
  BookingCancellation BookingCancellation[]
}

model BookingCancellation {
  id            String             @id @default(cuid())
  reason        CancellationReason
  cancelledTime DateTime
  booking       Booking            @relation(fields: [bookingId], references: [id])
  ticket        Ticket             @relation(fields: [ticketId], references: [id])
  bookingId     String
  ticketId      String
}

model Ticket {
  id                  String                @id @default(cuid())
  tricketNumber       Int
  booking             Booking               @relation(fields: [bookingId], references: [id])
  bookingId           String
  createdAt           DateTime              @default(now())
  BookingCancellation BookingCancellation[]
}

/// Represents a payment transaction for a single booking
model Payment {
  id               String        @id @default(cuid())
  amount           Decimal       @db.Decimal(10, 2)
  status           PaymentStatus @default(PENDING)
  gatewayPaymentId String? // e.g., Stripe or Razorpay charge ID
  method           String? // e.g., "upi", "card"

  // Relation to the specific booking this payment is for
  booking   Booking @relation(fields: [bookingId], references: [id])
  bookingId String  @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("payments")
}

model Reciept {
  id              String        @id @default(cuid())
  amount          Decimal       @db.Decimal(10, 2)
  promoCode       String?
  totalAmount     Decimal       @db.Decimal(10, 2)
  PaymentMethod   PaymentMethod @relation(fields: [paymentMethodId], references: [id])
  paymentMethodId String
  billingTime     DateTime
  bookingCategory String
}
